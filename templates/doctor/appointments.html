{% extends 'dashboard_base.html' %}

{% block title %}HealthConnect - Mes Rendez-vous{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/doctor/dashboard.css') }}">
<style>
    /* Styles spécifiques à la page des rendez-vous */
    .appointments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .appointments-filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-label {
        font-weight: 500;
        color: var(--text-color);
    }

    .filter-select {
        padding: 8px 12px;
        border-radius: var(--border-radius);
        border: 1px solid #e0e0e0;
        background-color: var(--white);
        color: var(--text-color);
        font-size: 0.9rem;
    }

    .appointments-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .appointments-table th {
        text-align: left;
        padding: 12px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        font-weight: 600;
        color: var(--text-color);
    }

    .appointments-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #e0e0e0;
        vertical-align: middle;
    }

    .appointments-table tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .patient-info {
        display: flex;
        align-items: center;
    }

    .patient-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 10px;
    }

    .patient-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .patient-name {
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 3px;
    }

    .patient-id {
        font-size: 0.8rem;
        color: var(--text-light);
    }

    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        text-align: center;
    }

    .status-pending {
        background-color: rgba(243, 156, 18, 0.2);
        color: #f39c12;
    }

    .status-accepted {
        background-color: rgba(88, 214, 141, 0.2);
        color: #27ae60;
    }

    .status-completed {
        background-color: rgba(52, 152, 219, 0.2);
        color: #3498db;
    }

    .status-rejected {
        background-color: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }

    .status-cancelled {
        background-color: rgba(149, 165, 166, 0.2);
        color: #7f8c8d;
    }

    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
        border: none;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
    }

    .btn-view {
        background-color: rgba(36, 113, 163, 0.1);
        color: var(--primary-color);
    }

    .btn-view:hover {
        background-color: rgba(36, 113, 163, 0.2);
    }

    .btn-accept {
        background-color: rgba(88, 214, 141, 0.1);
        color: #27ae60;
    }

    .btn-accept:hover {
        background-color: rgba(88, 214, 141, 0.2);
    }

    .btn-reject {
        background-color: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
    }

    .btn-reject:hover {
        background-color: rgba(231, 76, 60, 0.2);
    }

    .btn-video {
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }

    .btn-video:hover {
        background-color: rgba(52, 152, 219, 0.2);
    }

    .empty-state {
        text-align: center;
        padding: 40px 0;
        color: var(--text-light);
    }

    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #e0e0e0;
    }

    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }

    .pagination-info {
        color: var(--text-light);
        font-size: 0.9rem;
    }

    .pagination-controls {
        display: flex;
        gap: 10px;
    }

    .pagination-button {
        padding: 8px 12px;
        border-radius: 4px;
        background-color: var(--white);
        border: 1px solid #e0e0e0;
        cursor: pointer;
        transition: var(--transition);
    }

    .pagination-button:hover {
        background-color: #f8f9fa;
    }

    .pagination-button.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .pagination-button.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Statistiques des rendez-vous */
    .appointment-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 20px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }

    .stat-card[data-status="pending"] {
        border-left: 4px solid #f39c12;
    }

    .stat-card[data-status="accepted"] {
        border-left: 4px solid #27ae60;
    }

    .stat-card[data-status="completed"] {
        border-left: 4px solid #3498db;
    }

    .stat-card[data-status="rejected"] {
        border-left: 4px solid #e74c3c;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.5rem;
    }

    .stat-card[data-status="pending"] .stat-icon {
        background-color: rgba(243, 156, 18, 0.1);
        color: #f39c12;
    }

    .stat-card[data-status="accepted"] .stat-icon {
        background-color: rgba(39, 174, 96, 0.1);
        color: #27ae60;
    }

    .stat-card[data-status="completed"] .stat-icon {
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }

    .stat-card[data-status="rejected"] .stat-icon {
        background-color: rgba(231, 76, 60, 0.1);
        color: #e74c3c;
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1;
    }

    .stat-label {
        font-size: 0.9rem;
        color: var(--text-light);
        margin-top: 5px;
    }

    /* Onglets des rendez-vous */
    .appointment-tabs {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        overflow: hidden;
    }

    .tab-header {
        display: flex;
        border-bottom: 1px solid #e0e0e0;
        overflow-x: auto;
        scrollbar-width: none; /* Firefox */
    }

    .tab-header::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Edge */
    }

    .tab-button {
        padding: 15px 20px;
        background: none;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-color);
        position: relative;
        white-space: nowrap;
        transition: all 0.3s ease;
    }

    .tab-button:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .tab-button.active {
        color: var(--primary-color);
    }

    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background-color: var(--primary-color);
    }

    .tab-badge {
        display: inline-block;
        background-color: #f0f0f0;
        color: var(--text-color);
        border-radius: 20px;
        padding: 2px 8px;
        font-size: 0.8rem;
        margin-left: 8px;
    }

    .tab-button[data-tab="pending"] .tab-badge {
        background-color: rgba(243, 156, 18, 0.2);
        color: #f39c12;
    }

    .tab-button[data-tab="accepted"] .tab-badge {
        background-color: rgba(39, 174, 96, 0.2);
        color: #27ae60;
    }

    .tab-button[data-tab="completed"] .tab-badge {
        background-color: rgba(52, 152, 219, 0.2);
        color: #3498db;
    }

    .tab-button[data-tab="rejected"] .tab-badge {
        background-color: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }

    .tab-content {
        padding: 20px;
    }

    /* Amélioration du champ de recherche */
    .search-input-wrapper {
        position: relative;
        width: 250px;
    }

    .search-input-wrapper i {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
    }

    #search-input {
        width: 100%;
        padding: 8px 12px 8px 35px;
        border-radius: var(--border-radius);
        border: 1px solid #e0e0e0;
        background-color: var(--white);
        color: var(--text-color);
        font-size: 0.9rem;
    }

    /* Styles pour la prévisualisation du patient */
    .patient-preview {
        background-color: var(--white);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 20px;
        margin-top: 20px;
    }

    .preview-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .preview-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 15px;
    }

    .preview-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .preview-info h3 {
        margin: 0 0 5px 0;
        font-size: 1.2rem;
    }

    .preview-info p {
        margin: 0;
        color: var(--text-light);
    }

    .preview-section {
        margin-bottom: 15px;
    }

    .preview-section h4 {
        margin: 0 0 10px 0;
        font-size: 1rem;
        color: var(--text-color);
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 5px;
    }

    .preview-section p {
        margin: 0;
        color: var(--text-color);
    }

    .preview-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .preview-list li {
        padding: 5px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .preview-list li:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}
{% include 'doctor/partials/header.html' %}

<div class="dashboard-container">
    <!-- Sidebar (Menu latéral) -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Menu</span>
            <button id="sidebar-toggle" class="sidebar-toggle">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <div class="sidebar-menu">
            <div class="menu-category">CLINIC</div>
            <a href="{{ url_for('doctor.dashboard') }}" class="menu-item">
                <i class="fas fa-home"></i>
                <span class="menu-text">Accueil</span>
            </a>
            <a href="{{ url_for('doctor.patients') }}" class="menu-item">
                <i class="fas fa-user-injured"></i>
                <span class="menu-text">Patients</span>
            </a>
            <a href="{{ url_for('doctor.virtual_office') }}" class="menu-item">
                <i class="fas fa-laptop-medical"></i>
                <span class="menu-text">Cabinet Virtuel</span>
            </a>
            <a href="{{ url_for('doctor.appointments') }}" class="menu-item active">
                <i class="fas fa-calendar-alt"></i>
                <span class="menu-text">Rendez-vous</span>
            </a>

            <div class="menu-category">INTERACTION</div>
            <a href="{{ url_for('doctor.smart_agenda') }}" class="menu-item">
                <i class="fas fa-calendar-check"></i>
                <span class="menu-text">Agenda Intelligent</span>
            </a>
            <a href="{{ url_for('doctor.waiting_room') }}" class="menu-item">
                <i class="fas fa-hourglass-half"></i>
                <span class="menu-text">File d'Attente</span>
            </a>

            <div class="menu-category">RÉSEAU COLLABORATIF</div>
            <a href="{{ url_for('doctor.medical_network') }}" class="menu-item">
                <i class="fas fa-user-md"></i>
                <span class="menu-text">Réseau Médical</span>
            </a>
            <a href="{{ url_for('doctor.hospital_references') }}" class="menu-item">
                <i class="fas fa-hospital"></i>
                <span class="menu-text">Références Hospitalières</span>
            </a>
        </div>

        <div class="sidebar-footer">
            <a href="{{ url_for('doctor.settings') }}" class="menu-item">
                <i class="fas fa-cog"></i>
                <span class="menu-text">Paramètres</span>
            </a>
            <a href="{{ url_for('auth.logout') }}" class="menu-item">
                <i class="fas fa-sign-out-alt"></i>
                <span class="menu-text">Déconnexion</span>
            </a>
        </div>
    </div>

    <!-- Main Content (Zone principale) -->
    <div id="main-content" class="main-content">
        <div class="page-header">
            <h1 class="page-title">Mes Rendez-vous / Téléconsultations</h1>
            <p class="page-subtitle">Liste des patients ayant demandé une téléconsultation. Vous pouvez accepter, rejeter ou consulter les détails médicaux.</p>
        </div>

        <div class="dashboard-content">
            <!-- Statistiques des rendez-vous -->
            <div class="appointment-stats">
                <div class="stat-card" data-status="pending">
                    <div class="stat-icon">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ pending_count }}</div>
                        <div class="stat-label">En attente</div>
                    </div>
                </div>
                <div class="stat-card" data-status="accepted">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ accepted_count }}</div>
                        <div class="stat-label">Confirmés</div>
                    </div>
                </div>
                <div class="stat-card" data-status="completed">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ completed_count }}</div>
                        <div class="stat-label">Terminés</div>
                    </div>
                </div>
                <div class="stat-card" data-status="rejected">
                    <div class="stat-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">{{ rejected_count + cancelled_count }}</div>
                        <div class="stat-label">Refusés/Annulés</div>
                    </div>
                </div>
            </div>

            <!-- Onglets des rendez-vous -->
            <div class="appointment-tabs">
                <div class="tab-header">
                    <button class="tab-button active" data-tab="pending">
                        En attente
                        <span class="tab-badge">{{ pending_count }}</span>
                    </button>
                    <button class="tab-button" data-tab="accepted">
                        Confirmés
                        <span class="tab-badge">{{ accepted_count }}</span>
                    </button>
                    <button class="tab-button" data-tab="completed">
                        Terminés
                        <span class="tab-badge">{{ completed_count }}</span>
                    </button>
                    <button class="tab-button" data-tab="rejected">
                        Refusés/Annulés
                        <span class="tab-badge">{{ rejected_count + cancelled_count }}</span>
                    </button>
                    <button class="tab-button" data-tab="all">
                        Tous
                        <span class="tab-badge">{{ appointments|length }}</span>
                    </button>
                </div>

                <!-- Filtres -->
                <div class="appointments-filters">
                    <div class="filter-group">
                        <span class="filter-label">Date:</span>
                        <input type="date" id="date-filter" class="filter-select">
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Recherche:</span>
                        <div class="search-input-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" id="search-input" placeholder="Nom du patient ou ID...">
                        </div>
                    </div>
                    <div class="filter-group">
                        <span class="filter-label">Trier par:</span>
                        <select id="sort-filter" class="filter-select">
                            <option value="date_desc">Date (récent → ancien)</option>
                            <option value="date_asc">Date (ancien → récent)</option>
                            <option value="name_asc">Nom (A → Z)</option>
                            <option value="name_desc">Nom (Z → A)</option>
                        </select>
                    </div>
                </div>

                <!-- Contenu des onglets -->
                <div class="tab-content">
                    <!-- Tableau des rendez-vous -->
                    {% if appointments %}
                    <div class="table-responsive">
                        <table class="appointments-table" id="appointments-table">
                            <thead>
                                <tr>
                                    <th>ID Patient</th>
                                    <th>Nom & Prénom</th>
                                    <th>Date Demande</th>
                                    <th>Heure souhaitée</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for appointment in appointments %}
                                <tr data-appointment-id="{{ appointment.id }}" data-status="{{ appointment.status }}" data-date="{{ appointment.date_time.strftime('%Y-%m-%d') }}">
                                    <td>
                                        <span class="patient-id">P{{ appointment.patient.id }}</span>
                                    </td>
                                    <td>
                                        <div class="patient-info">
                                            <div class="patient-avatar">
                                                <img src="{{ url_for('static', filename='images/default-avatar.png') }}" alt="Patient">
                                            </div>
                                            <div>
                                                <div class="patient-name">{{ appointment.patient.user.first_name }} {{ appointment.patient.user.last_name }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ appointment.created_at.strftime('%d/%m/%Y') }}</td>
                                    <td>{{ appointment.date_time.strftime('%d/%m/%Y à %H:%M') }}</td>
                                    <td>
                                        {% if appointment.status == 'pending' %}
                                        <span class="status-badge status-pending">En attente</span>
                                        {% elif appointment.status == 'accepted' %}
                                        <span class="status-badge status-accepted">Confirmé</span>
                                        {% elif appointment.status == 'completed' %}
                                        <span class="status-badge status-completed">Terminé</span>
                                        {% elif appointment.status == 'rejected' %}
                                        <span class="status-badge status-rejected">Refusé</span>
                                        {% elif appointment.status == 'cancelled' %}
                                        <span class="status-badge status-cancelled">Annulé</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{{ url_for('doctor.patient_details', patient_id=appointment.patient.id) }}" class="btn-action btn-view">
                                                <i class="fas fa-folder-open"></i> Dossier
                                            </a>

                                            {% if appointment.status == 'pending' %}
                                            <a href="{{ url_for('doctor.appointment_action', appointment_id=appointment.id, action='accept') }}" class="btn-action btn-accept">
                                                <i class="fas fa-check"></i> Accepter
                                            </a>
                                            <a href="{{ url_for('doctor.appointment_action', appointment_id=appointment.id, action='reject') }}" class="btn-action btn-reject">
                                                <i class="fas fa-times"></i> Refuser
                                            </a>
                                            {% elif appointment.status == 'accepted' %}
                                            <a href="{{ url_for('doctor.consultation', appointment_id=appointment.id) }}" class="btn-action btn-video">
                                                <i class="fas fa-video"></i> Démarrer
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination">
                        <div class="pagination-info">
                            Affichage de <span id="showing-start">1</span> à <span id="showing-end">{{ appointments|length }}</span> sur <span id="total-count">{{ appointments|length }}</span> rendez-vous
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-button" id="prev-page" disabled><i class="fas fa-chevron-left"></i></button>
                            <button class="pagination-button active">1</button>
                            <button class="pagination-button" id="next-page" disabled><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>Aucun rendez-vous trouvé</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Socket.IO -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
<!-- Script de notifications -->
<script src="{{ url_for('static', filename='js/notifications.js') }}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle sidebar
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('main-content');

    sidebarToggle.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-collapsed');
        mainContent.classList.toggle('main-content-expanded');
    });

    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');

    mobileMenuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('sidebar-open');
    });

    // Gestion du statut du médecin
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');
    const doctorStatus = document.querySelector('.doctor-status');

    doctorStatus.addEventListener('click', function() {
        if (statusIndicator.classList.contains('status-online')) {
            statusIndicator.classList.remove('status-online');
            statusIndicator.classList.add('status-busy');
            statusText.textContent = 'Occupé';
        } else if (statusIndicator.classList.contains('status-busy')) {
            statusIndicator.classList.remove('status-busy');
            statusIndicator.classList.add('status-offline');
            statusText.textContent = 'Hors ligne';
        } else {
            statusIndicator.classList.remove('status-offline');
            statusIndicator.classList.add('status-online');
            statusText.textContent = 'En ligne';
        }
    });

    // Gestion des onglets et filtrage des rendez-vous
    const tabButtons = document.querySelectorAll('.tab-button');
    const dateFilter = document.getElementById('date-filter');
    const sortFilter = document.getElementById('sort-filter');
    const searchInput = document.getElementById('search-input');
    const appointmentsTable = document.getElementById('appointments-table');
    const statCards = document.querySelectorAll('.stat-card');

    if (appointmentsTable) {
        const rows = appointmentsTable.querySelectorAll('tbody tr');
        let currentTab = 'pending'; // Onglet par défaut

        // Fonction pour filtrer les rendez-vous
        function filterAppointments() {
            const dateValue = dateFilter.value;
            const searchValue = searchInput.value.toLowerCase();

            let visibleCount = 0;

            rows.forEach(row => {
                const rowStatus = row.getAttribute('data-status');
                const rowDate = row.getAttribute('data-date');
                const patientName = row.querySelector('.patient-name').textContent.toLowerCase();
                const patientId = row.querySelector('.patient-id').textContent.toLowerCase();

                // Vérifier si le statut correspond à l'onglet actif
                let statusMatch = false;
                if (currentTab === 'all') {
                    statusMatch = true;
                } else if (currentTab === 'rejected') {
                    statusMatch = rowStatus === 'rejected' || rowStatus === 'cancelled';
                } else {
                    statusMatch = rowStatus === currentTab;
                }

                let dateMatch = !dateValue || rowDate === dateValue;
                let searchMatch = !searchValue ||
                                patientName.includes(searchValue) ||
                                patientId.includes(searchValue);

                if (statusMatch && dateMatch && searchMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Mettre à jour les informations de pagination
            document.getElementById('showing-start').textContent = visibleCount > 0 ? '1' : '0';
            document.getElementById('showing-end').textContent = visibleCount;
            document.getElementById('total-count').textContent = visibleCount;

            // Afficher un message si aucun rendez-vous ne correspond aux filtres
            const emptyState = document.querySelector('.empty-state');
            if (visibleCount === 0 && rows.length > 0) {
                if (!emptyState) {
                    const newEmptyState = document.createElement('div');
                    newEmptyState.className = 'empty-state';
                    newEmptyState.innerHTML = `
                        <i class="fas fa-filter"></i>
                        <p>Aucun rendez-vous ne correspond à vos filtres</p>
                    `;
                    appointmentsTable.parentNode.appendChild(newEmptyState);
                }
                appointmentsTable.style.display = 'none';
            } else {
                if (emptyState) {
                    emptyState.style.display = rows.length > 0 ? 'none' : 'block';
                }
                appointmentsTable.style.display = 'table';
            }
        }

        // Fonction pour trier les rendez-vous
        function sortAppointments() {
            const sortValue = sortFilter.value;
            const tbody = appointmentsTable.querySelector('tbody');
            const rowsArray = Array.from(rows);

            rowsArray.sort((a, b) => {
                if (sortValue === 'date_desc') {
                    return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
                } else if (sortValue === 'date_asc') {
                    return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
                } else if (sortValue === 'name_asc') {
                    return a.querySelector('.patient-name').textContent.localeCompare(b.querySelector('.patient-name').textContent);
                } else if (sortValue === 'name_desc') {
                    return b.querySelector('.patient-name').textContent.localeCompare(a.querySelector('.patient-name').textContent);
                }
                return 0;
            });

            // Réorganiser les lignes dans le tableau
            rowsArray.forEach(row => {
                tbody.appendChild(row);
            });

            // Appliquer les filtres après le tri
            filterAppointments();
        }

        // Fonction pour changer d'onglet
        function changeTab(tabName) {
            // Mettre à jour l'onglet actif
            currentTab = tabName;

            // Mettre à jour les classes des boutons d'onglet
            tabButtons.forEach(button => {
                if (button.getAttribute('data-tab') === tabName) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Appliquer les filtres
            filterAppointments();
        }

        // Événements pour les onglets
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                changeTab(this.getAttribute('data-tab'));
            });
        });

        // Événements pour les cartes de statistiques
        statCards.forEach(card => {
            card.addEventListener('click', function() {
                changeTab(this.getAttribute('data-status'));
            });
        });

        // Événements pour les filtres
        dateFilter.addEventListener('change', filterAppointments);
        searchInput.addEventListener('input', filterAppointments);
        sortFilter.addEventListener('change', sortAppointments);

        // Appliquer le tri initial
        sortAppointments();

        // Activer l'onglet "En attente" par défaut
        changeTab('pending');
    }
});
</script>
{% endblock %}
